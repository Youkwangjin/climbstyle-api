<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="ko">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="_csrf" th:content="${_csrf.token}" />
    <meta name="_csrf_header" th:content="${_csrf.headerName}" />
    <title>프로필 수정 | ClimbStyle</title>
    <link rel="stylesheet" th:href="@{/css/common/common.css}">
    <link rel="stylesheet" th:href="@{/css/my/profile.css}">
</head>
<body>
<header>
    <div th:replace="~{fragments/common/header:: header}"></div>
</header>
<main class="section">
    <div class="container my-layout">
        <aside class="my-sidebar">
            <div class="my-user-summary">
                <div class="my-user-avatar">
                    <img th:if="${profile.userImgUrl != null}" th:src="${profile.userImgUrl}" alt="프로필 이미지">
                </div>
                <div class="my-user-meta">
                    <div class="my-user-name" th:text="${profile.userNickName}"></div>
                    <div class="my-user-email" th:text="${profile.userEmail}"></div>
                </div>
            </div>
            <nav class="my-menu" aria-label="마이페이지 메뉴">
                <a th:href="@{/my/profile}" class="my-menu-item">프로필</a>
                <a th:href="@{/my/orders}" class="my-menu-item">주문 내역</a>
                <a th:href="@{/my/likes}" class="my-menu-item">관심 상품</a>
                <a th:href="@{/my/reviews}" class="my-menu-item">내 리뷰</a>
                <a th:href="@{/my/profile/update}" class="my-menu-item is-active">계정 설정</a>
            </nav>
        </aside>
        <section class="my-content">
            <div class="head my-content-head">
                <div>
                    <h2>프로필 수정</h2>
                    <p>닉네임, 프로필 이미지, 소개 문구를 자유롭게 변경할 수 있어요.</p>
                </div>

                <div class="my-actions">
                    <a th:href="@{/my/profile}" class="btn">마이페이지로 돌아가기</a>
                </div>
            </div>

            <form class="my-form">
                <label>
                    <input hidden="hidden" id="userNo" th:value="${profile.userNo}"/>
                </label>
                <div class="my-grid">
                    <section class="my-card">
                        <div class="my-card-header">
                            <h3>기본 정보</h3>
                        </div>
                        <div class="my-form-body">
                            <div class="my-field">
                                <label for="userNm" class="my-field-label">이름</label>
                                <input id="userNm" name="userNm" type="text"
                                       class="my-input"
                                       th:value="${profile.userNm}"/>
                                <p class="my-field-help">실명은 주문/배송에 사용돼요.</p>
                            </div>

                            <div class="my-field">
                                <label for="userNickName" class="my-field-label">닉네임</label>
                                <input id="userNickName" name="userNickName" type="text"
                                       class="my-input"
                                       th:value="${profile.userNickName}"/>
                                <p class="my-field-help">커뮤니티와 리뷰에 노출되는 이름이에요.</p>
                            </div>

                            <div class="my-field">
                                <label for="userEmail" class="my-field-label">이메일</label>
                                <input id="userEmail" name="userEmail" type="email"
                                       class="my-input"
                                       th:value="${profile.userEmail}" readonly/>
                                <p class="my-field-help">로그인 및 알림 수신에 사용돼요. 변경은 고객센터로 문의해주세요.</p>
                            </div>
                        </div>
                    </section>

                    <section class="my-card">
                        <div class="my-card-header">
                            <h3>프로필 이미지 & 소개</h3>
                        </div>

                        <div class="my-form-body">
                            <div class="my-field">
                                <span class="my-field-label">프로필 이미지</span>
                                <div class="my-avatar-upload">
                                    <div class="my-avatar-preview">
                                        <img th:if="${profile.userImgUrl != null}" th:src="${profile.userImgUrl}"
                                             alt="프로필 이미지" class="preview-image">
                                    </div>
                                    <div class="my-avatar-upload-meta">
                                        <button type="button" class="btn btn-outline" onclick="upload()">이미지 업로드</button>
                                        <input id="userProfileImg" name="userProfileImg"
                                               type="file" accept="image/*" style="display: none;" onchange="readURL(this)" />
                                        <p class="my-field-help">5MB 이하의 JPG, PNG 이미지를 업로드할 수 있어요.</p>
                                    </div>
                                </div>
                            </div>

                            <div class="my-field">
                                <label for="userIntro" class="my-field-label">소개 문구</label>
                                <textarea id="userIntro"
                                          name="userIntro"
                                          rows="4"
                                          class="my-textarea"
                                          th:text="${profile.userIntro}"></textarea>
                                <p class="my-field-help">커뮤니티 프로필에서 보여줄 한 줄 소개를 적어주세요.</p>
                            </div>
                        </div>
                    </section>
                </div>

                <div class="my-form-footer">
                    <a th:href="@{/my/profile/update}" class="btn">취소</a>
                    <button type="button" class="btn btn-primary" onclick="update()">변경 내용 저장</button>
                </div>
            </form>

            <form class="my-form my-card my-card-password">
                <div class="my-card-header">
                    <h3>비밀번호 변경</h3>
                </div>

                <div class="my-form-body">
                    <div class="my-field">
                        <label for="currentPassword" class="my-field-label">현재 비밀번호</label>
                        <input id="currentPassword" type="password"
                               class="my-input" placeholder="현재 비밀번호를 입력하세요" />
                    </div>

                    <div class="my-field">
                        <label for="userPassword" class="my-field-label">새 비밀번호</label>
                        <input id="userPassword" type="password"
                               class="my-input" placeholder="영문, 숫자, 특수문자 조합 8~20자" />
                    </div>

                    <div class="my-field">
                        <label for="newUserPassword" class="my-field-label">새 비밀번호 확인</label>
                        <input id="newUserPassword" type="password"
                               class="my-input" placeholder="새 비밀번호를 한 번 더 입력하세요" />
                        <p class="my-field-help my-password-hint">다른 사이트와 동일한 비밀번호 사용은 피해 주세요.</p>
                    </div>
                </div>

                <div class="my-form-footer my-password-footer">
                    <button type="button" class="btn btn-primary" onclick="updatePassword()">비밀번호 변경</button>
                </div>
            </form>
            <section class="my-card my-card-dormant" aria-label="계정 휴면">
                <div class="my-card-header">
                    <h3>계정 휴면</h3>
                </div>
                <div class="my-form-body">
                    <div class="my-dormant-box">
                        <p class="my-dormant-title">잠시 쉬고 싶다면 계정을 휴면 상태로 전환할 수 있어요.</p>
                        <ul class="my-dormant-list">
                            <li>휴면 처리 후에는 로그인이 제한돼요.</li>
                            <li class="is-warn">휴면 상태가 30일 이상 지속되면 계정이 자동으로 탈퇴 처리됩니다.</li>
                        </ul>
                        <p class="my-dormant-help">휴면 처리는 계정 삭제가 아니며, 언제든지 다시 사용할 수 있어요.</p>
                    </div>
                </div>
                <div class="my-form-footer my-dormant-footer" th:if="${profile.userDeleteYn == 'N'}">
                    <button type="button" class="btn btn-danger-outline">계정 휴면 처리</button>
                </div>
            </section>
        </section>
    </div>
</main>
<footer>
    <div th:replace="~{fragments/common/footer :: footer}"></div>
</footer>
<script th:src="@{/js/common/logout.js}"></script>
<script th:src="@{/js/common/api.js}"></script>
<script th:src="@{/js/common/validator.js}"></script>
<script>
    function update () {
        if (!Validator.profile() || !confirm("변경 사항을 저장하시겠습니까?")) {
            return;
        }

        const formData = new FormData();
        formData.append("userNm", document.getElementById("userNm").value.trim());
        formData.append("userNickName", document.getElementById("userNickName").value.trim());
        formData.append("userIntro", document.getElementById("userIntro").value.trim());

        const userProfileImg = document.getElementById("userProfileImg").files[0];
        if (userProfileImg) {
            formData.append("userProfileImg", userProfileImg);
        }

        API.callFormData(`/api/v1/users/${document.getElementById("userNo").value}`, {
            method: "PATCH",
            body: formData
        })
            .then(async response => {
                const body = await response.json();

                if (!response.ok) {
                    alert(body.message);
                    return;
                }

                alert(body.message || "프로필이 수정되었습니다.");
                location.href = "/my/profile";
            })
            .catch(() => {
                alert("일시적인 문제가 발생했습니다. 지속될 경우 관리자에게 문의하세요.");
            });

    }

    function updatePassword() {
        if (!Validator.password() || !confirm("비밀번호를 변경하시겠습니까?")) {
            return;
        }

        API.callJson("/api/v1/users/password", {
            method: "PATCH",
            body: JSON.stringify({
                userPassword: document.getElementById("currentPassword").value.trim(),
                newUserPassword: document.getElementById("userPassword").value.trim()
            })
        })
            .then(async response => {
                const body = await response.json();

                if (!response.ok) {
                    alert(body.message);
                    return;
                }

                alert(body.message);
                Validator.clear(["currentPassword", "userPassword", "newUserPassword"]);
                logout();
            })
            .catch(() => {
                alert("일시적인 문제가 발생했습니다. 지속될 경우 관리자에게 문의하세요.");
            });
    }

    function upload() {
        document.getElementById("userProfileImg").click();
    }

    function readURL(input) {
        if (!input.files || input.files.length === 0) {
            alert("사진을 업로드 해주세요.");
            return;
        }

        const file = input.files[0];
        const allowedExts = ["jpg", "jpeg", "png", "gif"];
        const fileName = file.name;
        const fileExtension = fileName.split('.').pop().toLowerCase();

        if (!allowedExts.includes(fileExtension)) {
            alert("jpg, png, gif 이미지만 업로드 가능합니다.");
            document.getElementById("userProfileImg").value = "";
            return;
        }

        const reader = new FileReader();
        reader.onload = function(e) {
            const result = e.target.result;
            if (typeof result === 'string') {
                const previewImg = document.querySelector(".my-avatar-preview .preview-image");
                if (previewImg) {
                    previewImg.src = result;
                } else {
                    const newImg = document.createElement("img");
                    newImg.className = "preview-image";
                    newImg.src = result;
                    newImg.alt = "프로필 이미지";
                    document.querySelector(".my-avatar-preview").appendChild(newImg);
                }
            }
        };
        reader.readAsDataURL(file);
    }
</script>
</body>
</html>